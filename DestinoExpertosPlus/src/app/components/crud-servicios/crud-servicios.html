<!-- CARD PRINCIPAL -->
<app-card
  title="Gestión de Servicios"
  subtitle="Administra los servicios ofrecidos en la plataforma"
  content="Aquí puedes visualizar, editar y eliminar servicios, así como gestionar sus detalles y asignaciones a profesionales.">
</app-card>

<!-- BUSCADOR Y BOTONES -->
<div class="mb-4 mt-4 d-flex align-items-center gap-2">
  <input 
    type="text" 
    placeholder="Buscar servicios..." 
    class="border p-2 rounded w-full md:w-64" 
    #txtBuscar 
    (input)="search(txtBuscar)" 
  />

  <div style="margin-left: auto;">
    <!-- Botón claro: misma lógica (click)="openNew()" -->
    <button 
      class="btn btn-light border font-weight-bold py-2 px-4 rounded transition"
      (click)="openNew()">
      <i class="bi bi-tools"></i> <i class="bi bi-plus"></i> Nuevo Servicio
    </button>
  </div>
</div>


<!-- FILTROS -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
    </h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <!-- Filtro por Categoría -->
      <div class="col-md-4">
        <label class="form-label">Categoría</label>
        <select class="form-select" [(ngModel)]="filtroCategoria" (change)="aplicarFiltros()">
          <option value="">Todas las categorías</option>
          <option *ngFor="let categoria of categorias" [value]="categoria">
            {{ categoria }}
          </option>
        </select>
      </div>

      <!-- Filtro por Estado -->
      <div class="col-md-4">
        <label class="form-label">Estado</label>
        <select class="form-select" [(ngModel)]="filtroActivo" (change)="aplicarFiltros()">
          <option value="">Todos los estados</option>
          <option value="true">Activos</option>
          <option value="false">Inactivos</option>
        </select>
      </div>

      <!-- Botón Limpiar Filtros -->
      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()">
          <i class="bi bi-x-circle me-1"></i> Limpiar Filtros
        </button>
      </div>
    </div>

    <!-- Indicadores de filtros activos -->
    <div class="mt-3" *ngIf="filtroCategoria || filtroActivo !== null">
      <small class="text-muted">
        <i class="bi bi-info-circle me-1"></i>Filtros activos:
        <span class="badge bg-primary ms-2" *ngIf="filtroCategoria">
          Categoría: {{ filtroCategoria }}
        </span>
        <span class="badge bg-primary ms-2" *ngIf="filtroActivo === 'true'">
          Estado: Activo
        </span>
        <span class="badge bg-primary ms-2" *ngIf="filtroActivo === 'false'">
          Estado: Inactivo
        </span>
      </small>
    </div>
  </div>
</div>

<!-- TABLA -->
<app-data-table [data]="serviciosPaginados" [columns]="[
  { field: 'id', header: 'ID' },
  { field: 'nombre', header: 'Nombre' },
  { field: 'categoria', header: 'Categoría' },
  { field: 'descripcionCorta', header: 'Descripción' },
  { field: 'precioBaseFormateado', header: 'Precio Base' },
  { field: 'duracionFormateada', header: 'Duración' },
  { field: 'profesionalNombre', header: 'Profesional' },
  { field: 'activoFormateado', header: 'Activo' }
]">
  <ng-template #actions let-row>
    <div class="flex space-x-2">
      <button  (click)="view(row)"class="btn action-btn unified">
            <i class="bi bi-eye"></i>
            </button>
      <button (click)="openEdit(row)" class="btn action-btn unified">
        <i class="bi bi-pencil"></i>
      </button>
      <button (click)="openDeleteModal(row)"class="btn action-btn unified">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  </ng-template>
</app-data-table>

<!-- PAGINACIÓN -->
<div class="d-flex justify-content-between align-items-center mt-3" *ngIf="totalPaginas > 1">
  <div class="text-muted small">
    Mostrando {{ rangoRegistros }} registros
  </div>

  <nav aria-label="Paginación de servicios">
    <ul class="pagination mb-0">
      <!-- Botón Anterior -->
      <li class="page-item" [class.disabled]="paginaActual === 1">
        <a class="page-link" href="#" (click)="cambiarPagina(paginaActual - 1); $event.preventDefault()">
          <i class="bi bi-chevron-left"></i> Anterior
        </a>
      </li>

      <!-- Números de página -->
      <li class="page-item" *ngFor="let pagina of [].constructor(totalPaginas); let i = index"
          [class.active]="paginaActual === i + 1">
        <a class="page-link" href="#" (click)="cambiarPagina(i + 1); $event.preventDefault()">
          {{ i + 1 }}
        </a>
      </li>

      <!-- Botón Siguiente -->
      <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
        <a class="page-link" href="#" (click)="cambiarPagina(paginaActual + 1); $event.preventDefault()">
          Siguiente <i class="bi bi-chevron-right"></i>
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- MODAL REUTILIZABLE DE DETALLES -->
<app-detail-modal
  [isVisible]="showDetailModal"
  [data]="servicioDetalle"
  (close)="closeDetail()">
</app-detail-modal>

<!-- MODAL DE NOTIFICACIÓN DE ÉXITO -->
<div *ngIf="showNotificationModal" class="modal fade show d-block notification-modal success" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" (click)="showNotificationModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h5 class="modal-title mb-3">¡Éxito!</h5>
        <p class="mb-0">{{ notificationMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" (click)="showNotificationModal = false">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE ERROR -->
<div *ngIf="showErrorModal" class="modal fade show d-block notification-modal error" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" (click)="showErrorModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h5 class="modal-title mb-3">Error</h5>
        <p class="mb-0">{{ errorMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="showErrorModal = false">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE ELIMINAR -->
<div *ngIf="showDeleteModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i>
        </div>
        <h6 class="mb-3">¿Está seguro de eliminar el servicio #{{ servicio_a_Eliminar?.id }}?</h6>
        <div class="alert alert-light border">
          <p class="mb-1"><strong>Servicio:</strong></p>
          <p class="mb-0 text-muted">{{ servicio_a_Eliminar?.nombre }}</p>
        </div>
        <p class="text-muted small mt-3">
          Esta acción no se puede deshacer.
        </p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-secondary me-3" (click)="closeDeleteModal()">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i class="bi bi-trash3 me-1"></i> Sí, eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CREAR/EDITAR -->
<div class="modal fade" id="servicioModal" #servicioModal>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ servicioEdit ? 'Editar' : 'Nuevo' }} Servicio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form [formGroup]="formServicio">
        <div class="modal-body">
          <!-- CAMPO: Nombre con validaciones -->
          <div class="mb-3">
            <label class="form-label">Nombre *</label>
            <input type="text" class="form-control" formControlName="nombre" placeholder="Nombre del servicio">
            <span class="error">
              @if (formServicio.get('nombre')?.invalid &&
                  (formServicio.get('nombre')?.dirty || formServicio.get('nombre')?.touched)) {
                @if (formServicio.get('nombre')?.errors?.['required']) {
                  El nombre es obligatorio.
                }
                @if (formServicio.get('nombre')?.errors?.['minlength']) {
                  El nombre debe tener al menos 3 caracteres.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Categoría con validaciones -->
          <div class="mb-3">
            <label class="form-label">Categoría *</label>
            <select class="form-select" formControlName="categoria">
              <option value="">Seleccionar categoría...</option>
              <option *ngFor="let categoria of categorias" [value]="categoria">
                {{ categoria }}
              </option>
            </select>
            <span class="error">
              @if (formServicio.get('categoria')?.invalid &&
                  (formServicio.get('categoria')?.dirty || formServicio.get('categoria')?.touched)) {
                @if (formServicio.get('categoria')?.errors?.['required']) {
                  La categoría es obligatoria.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Descripción con validaciones -->
          <div class="mb-3">
            <label class="form-label">Descripción *</label>
            <textarea class="form-control" rows="3" formControlName="descripcion" 
                      placeholder="Descripción del servicio..."></textarea>
            <span class="error">
              @if (formServicio.get('descripcion')?.invalid &&
                  (formServicio.get('descripcion')?.dirty || formServicio.get('descripcion')?.touched)) {
                @if (formServicio.get('descripcion')?.errors?.['required']) {
                  La descripción es obligatoria.
                }
                @if (formServicio.get('descripcion')?.errors?.['minlength']) {
                  La descripción debe tener al menos 5 caracteres.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Precio Base con validaciones -->
          <div class="mb-3">
            <label class="form-label">Precio Base *</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" formControlName="precioBase" step="0.01" min="0">
            </div>
            <span class="error">
              @if (formServicio.get('precioBase')?.invalid &&
                  (formServicio.get('precioBase')?.dirty || formServicio.get('precioBase')?.touched)) {
                @if (formServicio.get('precioBase')?.errors?.['required']) {
                  El precio base es obligatorio.
                }
                @if (formServicio.get('precioBase')?.errors?.['min']) {
                  El precio debe ser mayor o igual a 0.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Duración con validaciones -->
          <div class="mb-3">
            <label class="form-label">Duración Estimada (minutos) *</label>
            <div class="input-group">
              <input type="number" class="form-control" formControlName="duracionEstimada" min="1">
              <span class="input-group-text">min</span>
            </div>
            <span class="error">
              @if (formServicio.get('duracionEstimada')?.invalid &&
                  (formServicio.get('duracionEstimada')?.dirty || formServicio.get('duracionEstimada')?.touched)) {
                @if (formServicio.get('duracionEstimada')?.errors?.['required']) {
                  La duración es obligatoria.
                }
                @if (formServicio.get('duracionEstimada')?.errors?.['min']) {
                  La duración debe ser al menos 1 minuto.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Profesional con validaciones -->
          <div class="mb-3">
            <label class="form-label">Profesional *</label>
            <select class="form-select" formControlName="profesional_id">
              <option value="">Seleccionar profesional...</option>
              <option *ngFor="let profesional of profesionales" [value]="profesional.id">
                {{ profesional.nombre }} - {{ profesional.especialidad || 'Sin especialidad' }}
              </option>
            </select>
            <span class="error">
              @if (formServicio.get('profesional_id')?.invalid &&
                  (formServicio.get('profesional_id')?.dirty || formServicio.get('profesional_id')?.touched)) {
                @if (formServicio.get('profesional_id')?.errors?.['required']) {
                  Debe seleccionar un profesional.
                }
              }
            </span>
          </div>

          <!-- CAMPO: Activo (checkbox) -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" formControlName="activo" id="checkActivo">
            <label class="form-check-label" for="checkActivo">
              Servicio activo
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="modalRef.hide()">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="save()">
            {{ servicioEdit ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>