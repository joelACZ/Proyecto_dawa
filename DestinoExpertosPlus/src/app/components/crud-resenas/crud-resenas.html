<h1 class="text-2xl font-bold mb-6">Gestión de Reseñas</h1>

<app-card
  title="Gestión de Reseñas"
  subtitle="Administra las reseñas creadas por los usuarios"
  content="Aquí puedes visualizar, editar y eliminar reseñas realizadas sobre los servicios prestados.">
</app-card>

<div class="mb-4 mt-4 flex justify-between items-center gap-2">
  <input
    type="text"
    placeholder="Buscar reseñas..."
    class="border p-2 rounded w-full md:w-64"
    #txtBuscar
    (input)="search(txtBuscar)"
  />
  <button
    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out"
    (click)="openNew()"
  >
    + Nueva Reseña
  </button>
</div>

<app-data-table
  [data]="resenasParaTabla"
  [columns]="[
    { field: 'id', header: 'ID' },
    { field: 'solicitud_id', header: 'Solicitud ID' },
    { field: 'calificacionFormateada', header: 'Calificación' },
    { field: 'comentario', header: 'Comentario' },
    { field: 'fecha', header: 'Fecha' },
    { field: 'anonimaFormateada', header: 'Anónima' }
  ]">
  <ng-template #actions let-row>
    <div class="flex space-x-2">
      <button class="text-blue-600 border border-blue-600 px-3 py-1 rounded hover:bg-blue-50 transition duration-150" 
              (click)="view(row)">Ver</button>
      <button class="text-yellow-600 border border-yellow-600 px-3 py-1 rounded hover:bg-yellow-50 transition duration-150" 
              (click)="openEdit(row)">Editar</button>
      <button class="text-red-600 border border-red-600 px-3 py-1 rounded hover:bg-red-50 transition duration-150" 
              (click)="openDeleteModal(row)">Eliminar</button>
    </div>
  </ng-template>
</app-data-table>

<!-- MODAL PARA NOTIFICACIONES DE ÉXITO -->
<div *ngIf="showNotificationModal" class="modal fade show d-block notification-modal success" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <button type="button" class="btn-close" (click)="closeNotificationModal()"></button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h5 class="modal-title mb-3">¡Éxito!</h5>
        <p class="mb-0">{{ notificationMessage }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-success" (click)="closeNotificationModal()">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA ERRORES -->
<div *ngIf="showErrorModal" class="modal fade show d-block notification-modal error" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <button type="button" class="btn-close" (click)="closeErrorModal()"></button>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h5 class="modal-title mb-3">Error</h5>
        <p class="mb-0">{{ errorMessage }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-danger" (click)="closeErrorModal()">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA VER DETALLES -->
<div *ngIf="showDetailModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalles de Reseña</h5>
        <button type="button" class="btn-close" (click)="closeDetail()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="resenaDetalle">
          <p><strong>ID:</strong> {{ resenaDetalle.id }}</p>
          <p><strong>Solicitud ID:</strong> {{ resenaDetalle.solicitud_id }}</p>
          <p><strong>Calificación:</strong> {{ resenaDetalle.calificacion }} ★ - {{ obtenerTextoCalificacion(resenaDetalle.calificacion) }}</p>
          <p><strong>Comentario:</strong> {{ resenaDetalle.comentario }}</p>
          <p><strong>Fecha:</strong> {{ resenaDetalle.fecha }}</p>
          <p><strong>Anónima:</strong> {{ resenaDetalle.anonima ? 'Sí' : 'No' }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetail()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA ELIMINAR RESEÑA (MEJORADO) -->
<div *ngIf="showDeleteModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i>
        </div>
        <h6 class="mb-3">¿Está seguro de eliminar la reseña #{{ resenaAEliminar?.id }}?</h6>
        <div class="alert alert-light border">
          <p class="mb-1"><strong>Comentario:</strong></p>
          <p class="mb-0 text-muted">"{{ resenaAEliminar?.comentario }}"</p>
        </div>
        <p class="text-muted small mt-3">
          Esta acción no se puede deshacer.
        </p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-secondary me-3" (click)="closeDeleteModal()">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i class="bi bi-trash3 me-1"></i> Sí, eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA CREAR/EDITAR RESEÑA -->
<div class="modal fade" id="resenaModal" tabindex="-1" #resenaModal>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ resenaEdit ? 'Editar Reseña' : 'Nueva Reseña' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <form [formGroup]="formResena">
        <div class="modal-body">
          <!-- ID de Solicitud -->
          <div class="mb-3">
            <label class="form-label">ID de Solicitud *</label>
            <input type="number" class="form-control" formControlName="solicitud_id" 
                   [class.is-invalid]="formResena.get('solicitud_id')?.invalid && formResena.get('solicitud_id')?.touched">
            <div class="invalid-feedback">
              El ID de solicitud es requerido y debe ser mayor a 0
            </div>
          </div>

          <!-- Calificación -->
          <div class="mb-3">
            <label class="form-label">Calificación *</label>
            <select class="form-select" formControlName="calificacion"
                    [class.is-invalid]="formResena.get('calificacion')?.invalid && formResena.get('calificacion')?.touched">
              <option value="">Seleccione una calificación</option>
              <option *ngFor="let opcion of opcionesCalificacion" [value]="opcion.valor">
                {{ opcion.texto }}
              </option>
            </select>
            <div class="invalid-feedback">
              Por favor seleccione una calificación
            </div>
          </div>

          <!-- Comentario -->
          <div class="mb-3">
            <label class="form-label">Comentario *</label>
            <textarea class="form-control" formControlName="comentario" rows="4"
                      [class.is-invalid]="formResena.get('comentario')?.invalid && formResena.get('comentario')?.touched"
                      placeholder="Escriba su comentario aquí..."></textarea>
            <div class="invalid-feedback">
              El comentario es requerido y debe tener entre 10 y 500 caracteres
            </div>
            <small class="form-text text-muted">
              {{ formResena.get('comentario')?.value?.length || 0 }}/500 caracteres
            </small>
          </div>

          <!-- Fecha -->
          <div class="mb-3">
            <label class="form-label">Fecha *</label>
            <input type="date" class="form-control" formControlName="fecha"
                   [class.is-invalid]="formResena.get('fecha')?.invalid && formResena.get('fecha')?.touched">
            <div class="invalid-feedback">
              La fecha es requerida
            </div>
          </div>

          <!-- Anónima -->
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" formControlName="anonima" id="checkAnonima">
            <label class="form-check-label" for="checkAnonima">
              Reseña anónima
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="modalRef.hide()">
            Cancelar
          </button>
          <button type="button" class="btn btn-primary" (click)="save()">
            {{ resenaEdit ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>