<app-card 
  title="Gestión de Reseñas" 
  subtitle="Administra las reseñas creadas por los usuarios"
  content="Aquí puedes visualizar, editar y eliminar reseñas realizadas sobre los servicios prestados.">
</app-card>

<div class="mb-4 mt-4 d-flex align-items-center gap-2">
  <input type="text" placeholder="Buscar reseñas..." class="border p-2 rounded w-full md:w-64" #txtBuscar (input)="aplicarFiltros()" />
  <div style="margin-left: auto" class="d-flex gap-2">
    <button class="btn btn-light border font-weight-bold py-2 px-4 rounded transition" (click)="abrirNuevo()">+ Nueva Reseña</button>
    <button class="btn btn-light border font-weight-bold py-2 px-4 rounded transition" (click)="navegarAListaResenas()">
      <i class="bi bi-list-ul me-1"></i> Lista de Reseñas
    </button>
  </div>
</div>

<app-data-table 
  [data]="resenasPaginadas" 
  [columns]="[
    { field: 'id', header: 'ID' },
    { field: 'servicio_nombre', header: 'Servicio' },
    { field: 'calificacionFormateada', header: 'Calificación' },
    { field: 'comentario', header: 'Comentario' },
    { field: 'fecha', header: 'Fecha' },
    { field: 'anonimaFormateada', header: 'Anónima' }
  ]">
  <ng-template #actions let-row>
    <div class="d-flex gap-2">
      <button (click)="verDetalle(row)" class="btn action-btn unified" title="Ver detalle"><i class="bi bi-eye"></i></button>
      <button (click)="abrirEdicion(row)" class="btn action-btn unified" title="Editar"><i class="bi bi-pencil"></i></button>
      <button (click)="abrirModalEliminar(row)" class="btn action-btn unified" title="Eliminar"><i class="bi bi-trash"></i></button>
    </div>
  </ng-template>
</app-data-table>

<div class="modal fade" id="resenaModal" #elementoModal>
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-bold">{{ resenaEnEdicion ? 'Editar' : 'Nueva' }} Reseña</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form [formGroup]="formResena">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Servicio *</label>
            <select class="form-select" formControlName="servicio_id">
              <option value="">Seleccionar servicio...</option>
              <option *ngFor="let s of servicios" [value]="s.id">{{ s.nombre }}</option>
            </select>
            <div class="text-danger small" *ngIf="formResena.get('servicio_id')?.touched && formResena.get('servicio_id')?.invalid">
              El servicio es obligatorio.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Cliente *</label>
            <select class="form-select" formControlName="cliente_id">
              <option value="">Seleccionar cliente...</option>
              <option *ngFor="let c of clientes" [value]="c.id">{{ c.nombre }}</option>
            </select>
            <div class="text-danger small" *ngIf="formResena.get('cliente_id')?.touched && formResena.get('cliente_id')?.invalid">
              El cliente es obligatorio.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Calificación *</label>
            <select class="form-select" formControlName="calificacion">
              <option value="">Seleccionar...</option>
              <option *ngFor="let o of opcionesCalificacion" [value]="o.valor">{{ o.texto }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Comentario *</label>
            <textarea class="form-control" rows="4" formControlName="comentario" placeholder="Escribe tu opinión..."></textarea>
            <div class="text-danger small" *ngIf="formResena.get('comentario')?.touched && formResena.get('comentario')?.invalid">
              Debe tener entre 10 y 500 caracteres.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Fecha *</label>
            <input type="date" class="form-control" formControlName="fecha" />
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" formControlName="anonima" id="checkAnonima" />
            <label class="form-check-label" for="checkAnonima">Reseña anónima</label>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary px-4" (click)="cerrarModalPrincipal()">Cancelar</button>
          <button type="button" class="btn btn-primary px-4" (click)="guardarResena()">
            <i class="bi bi-save me-1"></i> {{ resenaEnEdicion ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<app-detail-modal
  [isVisible]="mostrarModalDetalle"
  [data]="resenaDetalle"
  (close)="cerrarDetalle()">
</app-detail-modal>

<div *ngIf="mostrarModalEliminar" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i> Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModalEliminar()"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3"><i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i></div>
        <h6>¿Está seguro de eliminar la reseña #{{ resenaAEliminar?.id }}?</h6>
        <p class="text-danger small">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-secondary me-2" (click)="cerrarModalEliminar()">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmarEliminacion()">Sí, eliminar</button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="mostrarModalNotificacion" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center py-5">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 3.5rem;"></i>
        <h5 class="mt-3">¡Éxito!</h5>
        <p>{{ mensajeNotificacion }}</p>
        <button class="btn btn-success px-5" (click)="mostrarModalNotificacion = false">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="mostrarModalError" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center py-5">
        <i class="bi bi-x-circle-fill text-danger" style="font-size: 3.5rem;"></i>
        <h5 class="mt-3">Error</h5>
        <p>{{ mensajeError }}</p>
        <button class="btn btn-danger px-5" (click)="mostrarModalError = false">Cerrar</button>
      </div>
    </div>
  </div>
</div>